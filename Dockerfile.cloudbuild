# Optimized ComfyUI container for Docker Hub cloud builds - Multi-stage build
FROM ubuntu:24.04 AS builder

# Build arguments for flexibility in automated builds
ARG PYTORCH_VERSION=2.7.1
ARG ROCM_VERSION=6.4
ARG UBUNTU_VERSION=24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install build dependencies in one layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

WORKDIR /app

# Create virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install PyTorch with ROCm support - optimized for build cloud
RUN pip install --upgrade --no-cache-dir pip wheel && \
    pip install --no-cache-dir \
    --timeout 3600 \
    --retries 3 \
    torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/rocm${ROCM_VERSION}

# Clone ComfyUI with shallow clone to reduce size
RUN git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git . && \
    git log -1 --format="Commit: %H%nDate: %cd%nMessage: %s" > /app/BUILD_INFO.txt && \
    rm -rf .git

# Install ComfyUI requirements
RUN pip install --no-cache-dir --timeout 300 -r requirements.txt

# Install MIGraphX extension with shallow clone
RUN cd custom_nodes && \
    git clone --depth 1 https://github.com/pnikolic-amd/ComfyUI_MIGraphX.git && \
    cd ComfyUI_MIGraphX && \
    pip install --no-cache-dir --timeout 300 -r requirements.txt && \
    rm -rf .git

# Clean up pip cache explicitly
RUN pip cache purge 2>/dev/null || true && \
    find /opt/venv -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

# Final stage - minimal runtime image with metadata
FROM ubuntu:24.04

# Build arguments for labels (populated from GitHub secrets/variables)
ARG MAINTAINER_NAME="Your Name"
ARG MAINTAINER_EMAIL="your.email@example.com"
ARG VENDOR_NAME="Your Name"
ARG IMAGE_VERSION="1.0"
ARG DOCKERHUB_USERNAME="yourusername"
ARG GITHUB_USERNAME="yourusername"
ARG GITHUB_REPO="your-repo"
ARG IMAGE_DESCRIPTION="ComfyUI with AMD ROCm 6.4.4 support - Lightweight container using host ROCm"
ARG IMAGE_URL=""
ARG SOURCE_URL=""
ARG DOCUMENTATION_URL=""
ARG BUILD_DATE=""
ARG VCS_REF=""
ARG PYTORCH_VERSION=2.7.1
ARG ROCM_VERSION=6.4
ARG UBUNTU_VERSION=24.04

# Dynamic labels using build arguments
LABEL maintainer="${MAINTAINER_NAME} <${MAINTAINER_EMAIL}>"
LABEL description="${IMAGE_DESCRIPTION}"
LABEL version="${IMAGE_VERSION}"
LABEL vendor="${VENDOR_NAME}"
LABEL org.opencontainers.image.title="ComfyUI AMD ROCm"
LABEL org.opencontainers.image.description="${IMAGE_DESCRIPTION}"
LABEL org.opencontainers.image.vendor="${VENDOR_NAME}"
LABEL org.opencontainers.image.version="${IMAGE_VERSION}"
LABEL org.opencontainers.image.url="${IMAGE_URL:-https://hub.docker.com/r/${DOCKERHUB_USERNAME}/comfyui-rocm}"
LABEL org.opencontainers.image.source="${SOURCE_URL:-https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}}"
LABEL org.opencontainers.image.documentation="${DOCUMENTATION_URL:-https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/blob/main/docs/}"
LABEL org.opencontainers.image.licenses="GPL-3.0"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"

# Technical labels
LABEL rocm.version="${ROCM_VERSION}"
LABEL pytorch.version="${PYTORCH_VERSION}"
LABEL ubuntu.version="${UBUNTU_VERSION}"
LABEL gpu.support="AMD RDNA2,RDNA3,RDNA4"
LABEL consumer.gpu="RX7000,RX9000"

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTORCH_VERSION=${PYTORCH_VERSION}
ENV ROCM_VERSION=${ROCM_VERSION}
ENV PATH="/opt/venv/bin:$PATH"

# Install only runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    libgl1-mesa-dri \
    libglib2.0-0 \
    libgomp1 \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && apt-get autoremove -y

WORKDIR /app

# Copy virtual environment and app from builder
COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /app /app

# Create directories with proper permissions
RUN mkdir -p models/checkpoints models/vae models/loras models/controlnet models/unet \
    models/clip models/clip_vision models/style_models models/embeddings \
    models/diffusers models/gligen models/upscale_models \
    output input temp workflows \
    && chmod -R 755 models output input temp workflows custom_nodes

# Add build information with dynamic values
RUN echo "PyTorch Version: ${PYTORCH_VERSION}" >> /app/BUILD_INFO.txt && \
    echo "ROCm Version: ${ROCM_VERSION} (Compatible with ROCm 6.4.4)" >> /app/BUILD_INFO.txt && \
    echo "Ubuntu Version: ${UBUNTU_VERSION}" >> /app/BUILD_INFO.txt && \
    echo "Maintainer: ${MAINTAINER_NAME}" >> /app/BUILD_INFO.txt && \
    echo "Vendor: ${VENDOR_NAME}" >> /app/BUILD_INFO.txt && \
    echo "Version: ${IMAGE_VERSION}" >> /app/BUILD_INFO.txt && \
    echo "Build Date: ${BUILD_DATE}" >> /app/BUILD_INFO.txt && \
    echo "VCS Ref: ${VCS_REF}" >> /app/BUILD_INFO.txt

EXPOSE 8188

# Enhanced startup script with build info
RUN echo '#!/bin/bash\n\
echo "=== ComfyUI with Host ROCm 6.4.4 (Optimized Build) ==="\n\
echo "ðŸ—ï¸ Build Information:"\n\
cat /app/BUILD_INFO.txt\n\
echo ""\n\
echo "ðŸ³ Container: Ubuntu '${UBUNTU_VERSION}' (Minimal)"\n\
echo "ðŸ”¥ PyTorch: '${PYTORCH_VERSION}' with ROCm '${ROCM_VERSION}'"\n\
echo "ðŸ Python: $(python --version)"\n\
echo ""\n\
echo "ðŸ” Checking ROCm libraries..."\n\
ls -la /opt/rocm/lib/ 2>/dev/null | head -3 || echo "âš ï¸  ROCm libs not accessible (normal for host mount)"\n\
echo ""\n\
echo "ðŸ§ª PyTorch status:"\n\
python -c "import torch; print(f\"PyTorch: {torch.__version__}\"); print(f\"CUDA/ROCm available: {torch.cuda.is_available()}\"); print(f\"Device count: {torch.cuda.device_count()}\")" 2>/dev/null || echo "âŒ PyTorch check failed"\n\
echo ""\n\
if [ -f /opt/rocm/bin/rocm-smi ]; then\n\
    echo "ðŸŽ® GPU status:"\n\
    /opt/rocm/bin/rocm-smi --showid 2>/dev/null || echo "âŒ rocm-smi failed"\n\
    echo ""\n\
fi\n\
echo "ðŸš€ Starting ComfyUI on 0.0.0.0:8188..."\n\
echo "ðŸŒ Access at: http://localhost:8188"\n\
echo "ðŸ’¡ Note: Optimized build with reduced size"\n\
echo ""\n\
exec python main.py --listen 0.0.0.0 "$@"' > /app/start.sh && \
    chmod +x /app/start.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8188 || exit 1

CMD ["/app/start.sh"]